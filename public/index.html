<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script id="vs" type="x-shader/x-vertex">

        uniform mat4 modelMatrix;
        uniform mat4 viewMatrix;
        uniform mat4 projectionMatrix;
        uniform mat4 modelViewProjectionMatrix;

        attribute vec4 position;
        attribute vec3 normal;
        attribute vec2 texcoord;

        varying vec3 vNormal;
        varying vec3 vFragPosition;
        varying vec2 vTexcoord;
        
        void main() {
          vNormal = mat3(modelMatrix) * normal;
          vFragPosition = vec3(modelMatrix * position);
          vTexcoord = texcoord;
          gl_Position =  modelViewProjectionMatrix * position;
        }
          
    </script>
    <script id="fs" type="x-shader/x-fragment">

        #define PI 3.1415926535897932384626433832795
        #define MAX_MARCHING_STEPS 100

        #ifdef GL_ES
        // precision highp float;
        precision mediump float;
        #endif

        uniform sampler2D code;
        varying vec3 vNormal;
        varying vec3 vFragPosition;
        varying vec2 vTexcoord;

        float pixel2float(vec4 pixel) {
            float rByte = pixel.r * 255.0;
            float gByte = pixel.g * 255.0;
            float bByte = pixel.b * 255.0;
            float aByte = pixel.a * 255.0;

            float s = -step(127.0, aByte);
            float eLastBit = step(127.0, bByte);
            float e = (aByte + s * 128.0) * 2.0 + eLastBit;
            float m = (bByte - eLastBit * 128.0) * 65536.0 + gByte * 256.0 + rByte;
            float f = (s * 2.0 + 1.0) * (1.0 + m / 8388608.0) * pow(2.0, e - 127.0);
            return f;
        }

        float getCardData(sampler2D code, inout int pos, int width, int height) {
            int y = pos / width;
            int x = pos - y * width;
            vec2 uv = vec2(float(x)/ float(width), float(y) / float(height));
            vec4 pixel = texture2D(code, uv);
            pos++;
            return pixel2float(pixel);
        }

        struct Registers{
            mat4  r[10];    // 0
            int   pos;      // 1000
            int   esp;      // 1001
        };

        struct PCInput{
            float argf[100];
            sampler2D argt[10];
        };

        struct PCOutput{
            float data[100];
            float code;
        };

        uniform PCInput pcinput;
        PCOutput pcoutput;

        void run(sampler2D code) {
            pcoutput.code = 0.0;
            float memory[100];
            Registers regs;
            regs.pos = 0;
            regs.esp = 100;
            int width = int(getCardData(code, regs.pos, 100, 100));
            int height = int(getCardData(code, regs.pos, width, 100));


        }

        void main() {
            run(code);
            gl_FragColor = vec4(pcoutput.data[0], pcoutput.data[1], pcoutput.data[2], pcoutput.data[3]);
        }
          
    </script>
    <canvas id="c"></canvas>
</body>

</html>